#!/usr/bin/env bash
# Install shellcheck (shell script linter) and shfmt (shell script formatter)
set -euo pipefail

echo "==> Installing shellcheck and shfmt..."

# Install shellcheck via apt
if command -v shellcheck >/dev/null 2>&1; then
  echo "✓ shellcheck already installed: $(shellcheck --version | head -2 | tail -1)"
else
  echo "==> Installing shellcheck via apt..."
  sudo DEBIAN_FRONTEND=noninteractive apt-get update -y
  sudo DEBIAN_FRONTEND=noninteractive apt-get install -y shellcheck
  echo "✓ shellcheck installed: $(shellcheck --version | head -2 | tail -1)"
fi

# shfmt - install via Go (requires golang-go from prerequisites)
if command -v shfmt >/dev/null 2>&1; then
  echo "✓ shfmt already installed: $(shfmt --version)"
else
  if ! command -v go >/dev/null 2>&1; then
    echo "Error: Go not found. Install prerequisites first (run_once_000-prerequisites.sh)." >&2
    exit 1
  fi

  echo "==> Installing shfmt via Go..."
  GO111MODULE=on go install mvdan.cc/sh/v3/cmd/shfmt@latest

  INSTALL_DIR="$HOME/.local/bin"
  mkdir -p "$INSTALL_DIR"

  # Copy built binary to ~/.local/bin
  if [ -x "$HOME/go/bin/shfmt" ]; then
    install -m 0755 "$HOME/go/bin/shfmt" "$INSTALL_DIR/shfmt"
  elif [ -n "${GOPATH:-}" ] && [ -x "$GOPATH/bin/shfmt" ]; then
    install -m 0755 "$GOPATH/bin/shfmt" "$INSTALL_DIR/shfmt"
  else
    echo "Error: go install did not produce shfmt binary." >&2
    exit 1
  fi

  echo "✓ shfmt installed: $INSTALL_DIR/shfmt ($(shfmt --version))"
fi

echo "✓ Shell linting and formatting tools ready"
