#!/usr/bin/env bash
# Install Docker Engine and Docker Compose on host system
set -euo pipefail

# Skip in Docker containers (Docker-in-Docker is complex and not needed for testing)
if [ -f /.dockerenv ]; then
  echo "==> Running in Docker, skipping Docker installation (use host system)"
  exit 0
fi

# Check if already installed
if command -v docker >/dev/null 2>&1 && command -v docker-compose >/dev/null 2>&1; then
  echo "✓ Docker already installed:"
  echo "  Docker: $(docker --version)"
  echo "  Docker Compose: $(docker-compose --version)"
  exit 0
fi

# Require apt-based systems
if ! command -v apt-get >/dev/null 2>&1; then
  echo "Error: apt-get not found. Please install Docker manually: https://docs.docker.com/engine/install/" >&2
  exit 1
fi

# Require sudo
if ! command -v sudo >/dev/null 2>&1; then
  echo "Error: sudo not found. Docker installation requires sudo privileges." >&2
  exit 1
fi

echo "==> Installing Docker Engine and Docker Compose..."

# Install prerequisites
sudo DEBIAN_FRONTEND=noninteractive apt-get update -y
sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
  ca-certificates \
  curl \
  gnupg \
  lsb-release

# Install Docker Engine using official script
echo "==> Installing Docker Engine..."
if ! curl -fsSL https://get.docker.com -o /tmp/get-docker.sh; then
  echo "Error: Failed to download Docker installation script" >&2
  exit 1
fi

# Run Docker installation script (non-interactive)
if ! sudo sh /tmp/get-docker.sh; then
  echo "Error: Docker installation failed" >&2
  rm -f /tmp/get-docker.sh
  exit 1
fi

rm -f /tmp/get-docker.sh

# Install Docker Compose standalone binary
echo "==> Installing Docker Compose..."
COMPOSE_VERSION="v2.24.5" # Latest stable version as of 2024

# Detect architecture for Docker Compose
case "$(uname -m)" in
x86_64 | amd64) compose_arch="x86_64" ;;
aarch64 | arm64) compose_arch="aarch64" ;;
*)
  echo "Error: Unsupported architecture for Docker Compose: $(uname -m)" >&2
  exit 1
  ;;
esac

COMPOSE_URL="https://github.com/docker/compose/releases/download/${COMPOSE_VERSION}/docker-compose-linux-${compose_arch}"

# Download and install Docker Compose
if ! sudo curl -fsSL "$COMPOSE_URL" -o /usr/local/bin/docker-compose; then
  echo "Error: Failed to download Docker Compose" >&2
  exit 1
fi

sudo chmod +x /usr/local/bin/docker-compose

# Verify Docker Compose installation
if ! /usr/local/bin/docker-compose --version >/dev/null 2>&1; then
  echo "Error: Docker Compose installation verification failed" >&2
  exit 1
fi

# Add current user to docker group (if not root)
if [ "$(id -u)" -ne 0 ]; then
  CURRENT_USER="${SUDO_USER:-$USER}"
  if [ -z "$CURRENT_USER" ]; then
    CURRENT_USER=$(whoami)
  fi

  # Check if docker group exists
  if getent group docker >/dev/null 2>&1; then
    # Check if user is already in docker group
    if ! groups "$CURRENT_USER" | grep -q docker; then
      echo "==> Adding user '$CURRENT_USER' to docker group..."
      sudo usermod -aG docker "$CURRENT_USER"
      echo "  Note: You may need to log out and log back in for group changes to take effect."
      echo "  Alternatively, run: newgrp docker"
    else
      echo "✓ User '$CURRENT_USER' is already in docker group"
    fi
  else
    echo "Warning: docker group not found, skipping user group addition" >&2
  fi
else
  echo "  Running as root, skipping user group addition"
fi

# Start and enable Docker service (if systemd is available)
if command -v systemctl >/dev/null 2>&1 && systemctl is-system-running >/dev/null 2>&1; then
  echo "==> Starting Docker service..."
  sudo systemctl enable docker
  sudo systemctl start docker
  echo "✓ Docker service started and enabled"
else
  echo "  Note: systemd not available, Docker service may need to be started manually"
fi

# Verify installation
echo "==> Verifying installation..."
if command -v docker >/dev/null 2>&1 && command -v docker-compose >/dev/null 2>&1; then
  echo "✓ Docker Engine installed: $(docker --version)"
  echo "✓ Docker Compose installed: $(docker-compose --version)"
  echo ""
  echo "Note: If you were added to the docker group, log out and log back in,"
  echo "      or run 'newgrp docker' to use Docker without sudo."
else
  echo "Error: Installation verification failed" >&2
  exit 1
fi
