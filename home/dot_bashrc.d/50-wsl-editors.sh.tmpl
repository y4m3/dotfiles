{{- if and (eq .chezmoi.os "linux") (.chezmoi.kernel.osrelease | lower | contains "microsoft") -}}
#!/usr/bin/env bash
# WSL: Cursor/VSCode editor integration for WSL and SSH sessions
# Variables (CURSOR_BIN, VSCODE_BIN, WSL_DISTRO, SSH_HOST) defined in ~/.bashrc.local

# Skip if required variables are not configured
[[ -z "$CURSOR_BIN" && -z "$VSCODE_BIN" ]] && return 0
[[ -z "$WSL_DISTRO" ]] && return 0

_editor_is_ssh_access() {
    # Check standard SSH indicators first
    [[ -n "$SSH_CONNECTION" || -n "$SSH_CLIENT" ]] && return 0
    # Fall back to WezTerm mux detection
    [[ "$WEZTERM_EXECUTABLE" == */wezterm-mux-server ]] && return 0
    return 1
}

_open_editor() {
    local editor_bin="$1"
    shift

    # Flags-only (e.g., --help, --version): pass through without --remote
    if [[ $# -gt 0 ]]; then
        local all_flags=true
        local arg
        for arg in "$@"; do
            if [[ "$arg" != -* ]]; then
                all_flags=false
                break
            fi
        done
        if [[ "$all_flags" == true ]]; then
            WSL_DISTRO_NAME="$WSL_DISTRO" "$editor_bin" "$@"
            return
        fi
    fi

    local remote_spec
    if _editor_is_ssh_access; then
        if [[ -n "$SSH_HOST" ]]; then
            remote_spec="ssh-remote+${SSH_HOST}"
        else
            echo "warning: SSH access detected but SSH_HOST not set; using WSL distro '${WSL_DISTRO}' as remote target (wsl+${WSL_DISTRO})" >&2
            remote_spec="wsl+${WSL_DISTRO}"
        fi
    else
        remote_spec="wsl+${WSL_DISTRO}"
    fi

    # Resolve paths (supports multiple files, non-existent paths via -m)
    local resolved_paths=()
    if [[ $# -eq 0 ]]; then
        resolved_paths+=("$(realpath -m ".")")
    else
        for arg in "$@"; do
            # Skip flags, resolve paths
            if [[ "$arg" == -* ]]; then
                resolved_paths+=("$arg")
            else
                resolved_paths+=("$(realpath -m "$arg")")
            fi
        done
    fi

    # Filter out the "defined more than once" warning from stderr only
    # Using temp file to avoid process substitution race issues
    local tmp_stderr editor_status
    tmp_stderr="$(mktemp)"
    WSL_DISTRO_NAME="$WSL_DISTRO" "$editor_bin" \
        --remote "$remote_spec" "${resolved_paths[@]}" \
        2>| "$tmp_stderr"
    editor_status=$?
    if [[ -s "$tmp_stderr" ]]; then
        grep -v "Option 'remote' is defined more than once" "$tmp_stderr" >&2 || true
    fi
    rm -f "$tmp_stderr"
    return "$editor_status"
}

[[ -n "$CURSOR_BIN" ]] && cursor() { _open_editor "$CURSOR_BIN" "$@"; }
[[ -n "$VSCODE_BIN" ]] && code() { _open_editor "$VSCODE_BIN" "$@"; }
{{- end }}
