{{- if and (eq .chezmoi.os "linux") (.chezmoi.kernel.osrelease | lower | contains "microsoft") -}}
#!/usr/bin/env bash
# WSL: Cursor/VSCode editor integration for WSL and SSH sessions
# Variables (CURSOR_BIN, VSCODE_BIN, WSL_DISTRO, SSH_HOST) defined in ~/.bashrc.local

# Skip if required variables are not configured
[[ -z "$CURSOR_BIN" && -z "$VSCODE_BIN" ]] && return 0
[[ -z "$WSL_DISTRO" ]] && return 0

_editor_is_ssh_access() {
    [[ "$WEZTERM_EXECUTABLE" == */wezterm-mux-server ]]
}

_open_editor() {
    local editor_bin="$1"
    shift

    # Non-path arguments (e.g., --help, --version): pass through
    if [[ $# -gt 0 && "$1" != "." && ! -e "$1" ]]; then
        WSL_DISTRO_NAME="$WSL_DISTRO" "$editor_bin" "$@"
        return
    fi

    local remote_spec
    if _editor_is_ssh_access && [[ -n "$SSH_HOST" ]]; then
        remote_spec="ssh-remote+${SSH_HOST}"
    else
        remote_spec="wsl+${WSL_DISTRO}"
    fi

    # Set WSL_DISTRO_NAME to help CLI detect WSL environment correctly
    # Filter out the "defined more than once" warning (CLI adds --remote internally)
    WSL_DISTRO_NAME="$WSL_DISTRO" "$editor_bin" \
        --remote "$remote_spec" "$(realpath "${1:-.}")" 2>&1 \
        | grep -v "Option 'remote' is defined more than once"
}

[[ -n "$CURSOR_BIN" ]] && cursor() { _open_editor "$CURSOR_BIN" "$@"; }
[[ -n "$VSCODE_BIN" ]] && code() { _open_editor "$VSCODE_BIN" "$@"; }
{{- end }}
