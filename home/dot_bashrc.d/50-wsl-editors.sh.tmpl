{{- if and (eq .chezmoi.os "linux") (.chezmoi.kernel.osrelease | lower | contains "microsoft") -}}
#!/usr/bin/env bash
# WSL: Cursor/VSCode editor integration for WSL and SSH sessions
# Variables (CURSOR_BIN, VSCODE_BIN, WSL_DISTRO, SSH_HOST) defined in ~/.bashrc.local

# Skip if required variables are not configured
[[ -z "$CURSOR_BIN" && -z "$VSCODE_BIN" ]] && return 0
[[ -z "$WSL_DISTRO" ]] && return 0

_editor_is_ssh_access() {
    [[ "$WEZTERM_EXECUTABLE" == */wezterm-mux-server ]]
}

_open_editor() {
    local editor_bin="$1"
    shift

    # Flags (e.g., --help, --version): pass through without --remote
    if [[ $# -gt 0 && "$1" == -* ]]; then
        WSL_DISTRO_NAME="$WSL_DISTRO" "$editor_bin" "$@"
        return
    fi

    local remote_spec
    if _editor_is_ssh_access; then
        if [[ -n "$SSH_HOST" ]]; then
            remote_spec="ssh-remote+${SSH_HOST}"
        else
            echo "warning: SSH access detected but SSH_HOST not set, falling back to WSL mode" >&2
            remote_spec="wsl+${WSL_DISTRO}"
        fi
    else
        remote_spec="wsl+${WSL_DISTRO}"
    fi

    # Set WSL_DISTRO_NAME to help CLI detect WSL environment correctly
    # Filter out the "defined more than once" warning from stderr only
    WSL_DISTRO_NAME="$WSL_DISTRO" "$editor_bin" \
        --remote "$remote_spec" "$(realpath -m "${1:-.}")" \
        2> >(grep -v "Option 'remote' is defined more than once" >&2)
}

[[ -n "$CURSOR_BIN" ]] && cursor() { _open_editor "$CURSOR_BIN" "$@"; }
[[ -n "$VSCODE_BIN" ]] && code() { _open_editor "$VSCODE_BIN" "$@"; }
{{- end }}
