{{- if and (eq .chezmoi.os "linux") (eq .profile "client") (contains "debian" .chezmoi.osRelease.idLike) -}}
#!/usr/bin/env bash
# Install Tokyo Night themes for bat
# Uses bat-into-tokyonight script from https://github.com/0xTadash1/bat-into-tokyonight
set -euo pipefail

log() { printf '%s\n' "==> $*"; }
err() { printf '%s\n' "Error: $*" >&2; }

# Ensure cargo bin is in PATH (bat is installed via cargo)
CARGO_BIN="$HOME/.cargo/bin"
if [ -d "$CARGO_BIN" ]; then
  export PATH="$CARGO_BIN:$PATH"
fi

# Load cargo env to ensure PATH/vars are set (handles non-interactive shells)
if [ -f "$HOME/.cargo/env" ]; then
  # shellcheck disable=SC1091
  source "$HOME/.cargo/env"
fi

# Require bat to be installed first
# Check both in PATH and directly in ~/.cargo/bin
if ! command -v bat >/dev/null 2>&1 && [ ! -x "$CARGO_BIN/bat" ]; then
  err "bat not found. Install bat first (run_once_210-shell-cargo-tools.sh)."
  exit 1
fi

# Use bat from PATH or directly from ~/.cargo/bin
BAT_CMD=""
if command -v bat >/dev/null 2>&1; then
  BAT_CMD="bat"
elif [ -x "$CARGO_BIN/bat" ]; then
  BAT_CMD="$CARGO_BIN/bat"
else
  err "bat command not found"
  exit 1
fi

# Get bat config directory
BAT_CONFIG_DIR=$("$BAT_CMD" --config-dir 2>/dev/null || echo "$HOME/.config/bat")
BAT_THEMES_DIR="$BAT_CONFIG_DIR/themes"
TOKYONIGHT_THEMES_DIR="$BAT_THEMES_DIR/tokyonight.nvim"

# Check if Tokyo Night themes are already installed
# The script installs 4 themes: tokyonight_day, tokyonight_moon, tokyonight_night, tokyonight_storm
# Verify both file existence and bat cache availability
if [ -d "$TOKYONIGHT_THEMES_DIR" ] &&
  [ -f "$TOKYONIGHT_THEMES_DIR/tokyonight_day.tmTheme" ] &&
  [ -f "$TOKYONIGHT_THEMES_DIR/tokyonight_night.tmTheme" ]; then
  # Verify themes are available in bat cache
  if "$BAT_CMD" --list-themes 2>/dev/null | grep -q "tokyonight_night"; then
    log "Tokyo Night themes already installed and verified"
    exit 0
  else
    log "Themes found but not in bat cache, rebuilding cache..."
    "$BAT_CMD" cache --build >/dev/null 2>&1 || {
      err "Failed to build bat cache"
      exit 1
    }
    # Verify again after cache rebuild
    if "$BAT_CMD" --list-themes 2>/dev/null | grep -q "tokyonight_night"; then
      log "Tokyo Night themes verified in bat cache"
      exit 0
    else
      log "Themes still not found in bat cache after rebuild, reinstalling..."
      # Continue to installation below
    fi
  fi
fi

# Temporary directory for cloning the repository
TMP_DIR=$(mktemp -d)
trap 'rm -rf "$TMP_DIR"' EXIT

# Clone or update bat-into-tokyonight repository
REPO_URL="https://github.com/0xTadash1/bat-into-tokyonight.git"
REPO_DIR="$TMP_DIR/bat-into-tokyonight"

log "Cloning bat-into-tokyonight repository..."
if ! git clone --depth 1 "$REPO_URL" "$REPO_DIR" >/dev/null 2>&1; then
  err "Failed to clone bat-into-tokyonight repository"
  exit 1
fi

# Make script executable
SCRIPT_PATH="$REPO_DIR/bat-into-tokyonight"
if [ ! -f "$SCRIPT_PATH" ]; then
  err "bat-into-tokyonight script not found"
  exit 1
fi

chmod +x "$SCRIPT_PATH"

# Run the script (it handles install/update and cache build)
log "Installing Tokyo Night themes for bat..."
if ! bash "$SCRIPT_PATH" 2>&1; then
  err "Failed to install Tokyo Night themes"
  exit 1
fi

# Verify installation
if [ -d "$TOKYONIGHT_THEMES_DIR" ] &&
  "$BAT_CMD" --list-themes 2>/dev/null | grep -q "tokyonight_night"; then
  log "âœ“ Tokyo Night themes installed successfully"
  log "  Available themes: tokyonight_day, tokyonight_moon, tokyonight_night, tokyonight_storm"
else
  err "Tokyo Night themes installation verification failed"
  exit 1
fi
{{- end -}}
