{{- if and (eq .chezmoi.os "linux") (eq (.profile | default "client") "client") (contains "debian" .chezmoi.osRelease.idLike) -}}
#!/usr/bin/env bash
# Install Go (latest stable) to ~/.local/go
set -euo pipefail

GOROOT="$HOME/.local/go"

echo "==> Checking Go installation..."

# Skip if Go is already installed
if [ -x "$GOROOT/bin/go" ]; then
    echo "✓ Go already installed: $("$GOROOT/bin/go" version)"
    exit 0
fi

echo "==> Installing Go..."

# Get latest stable version from go.dev
GO_VERSION=$(curl -fsSL https://go.dev/VERSION?m=text | head -1)
if [ -z "$GO_VERSION" ]; then
    echo "Error: Failed to fetch Go version from go.dev" >&2
    exit 1
fi

# Validate version format (should start with "go")
case "$GO_VERSION" in
    go*)
        ;;
    *)
        echo "Error: Invalid Go version format: '$GO_VERSION'" >&2
        exit 1
        ;;
esac
echo "  Latest version: $GO_VERSION"

# Detect architecture
case "$(uname -m)" in
    x86_64 | amd64) ARCH="amd64" ;;
    aarch64 | arm64) ARCH="arm64" ;;
    *)
        echo "Error: Unsupported architecture: $(uname -m)" >&2
        exit 1
        ;;
esac

# Download checksum for verification
echo "  Downloading checksum..."
CHECKSUM_URL="https://go.dev/dl/${GO_VERSION}.linux-${ARCH}.tar.gz.sha256"
EXPECTED_CHECKSUM=$(curl -fsSL "$CHECKSUM_URL")
if [ -z "$EXPECTED_CHECKSUM" ]; then
    echo "Error: Failed to download checksum from $CHECKSUM_URL" >&2
    exit 1
fi
echo "  Expected SHA256: $EXPECTED_CHECKSUM"

# Download and verify in temporary directory
TEMP_DIR=$(mktemp -d)
trap 'rm -rf "$TEMP_DIR"' EXIT INT TERM

cd "$TEMP_DIR"
echo "  Downloading Go archive..."
curl -fsSL "https://go.dev/dl/${GO_VERSION}.linux-${ARCH}.tar.gz" -o go.tar.gz

# Verify checksum
echo "  Verifying checksum..."
ACTUAL_CHECKSUM=$(sha256sum go.tar.gz | awk '{print $1}')
if [ "$ACTUAL_CHECKSUM" != "$EXPECTED_CHECKSUM" ]; then
    echo "Error: Checksum mismatch!" >&2
    echo "  Expected: $EXPECTED_CHECKSUM" >&2
    echo "  Actual:   $ACTUAL_CHECKSUM" >&2
    exit 1
fi
echo "  ✓ Checksum verified"

# Extract
echo "  Extracting..."
mkdir -p "$HOME/.local"
tar -C "$HOME/.local" -xzf go.tar.gz

# Verify installation
if [ -x "$GOROOT/bin/go" ]; then
    echo "✓ Go installed successfully"
    echo "  $("$GOROOT/bin/go" version)"
    echo "  GOROOT: $GOROOT"
else
    echo "Error: Go installation failed" >&2
    exit 1
fi
{{- end -}}
