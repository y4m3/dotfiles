{{- if and (eq .chezmoi.os "linux") (eq (.profile | default "client") "client") (contains "debian" .chezmoi.osRelease.idLike) -}}
#!/usr/bin/env bash
# Install apt packages that cannot be managed by Nix
# - vim-gtk3: Required for WSL clipboard integration
# - unzip, curl, ca-certificates: Required for win32yank installer

set -euo pipefail

# Skip in Docker containers
if [ -f /.dockerenv ]; then
  echo "==> Running in Docker, skipping apt packages"
  exit 0
fi

echo "==> Checking apt packages..."

PACKAGES_TO_INSTALL=()

# Check vim with clipboard support
if ! (command -v vim &>/dev/null && vim --version | grep -q "+clipboard"); then
  PACKAGES_TO_INSTALL+=(vim-gtk3)
fi

# Check prerequisites for win32yank installer (WSL only)
for pkg in unzip curl ca-certificates; do
  if ! dpkg -s "$pkg" &>/dev/null; then
    PACKAGES_TO_INSTALL+=("$pkg")
  fi
done

if [ ${#PACKAGES_TO_INSTALL[@]} -eq 0 ]; then
  echo "✓ All apt packages already installed"
  exit 0
fi

echo "==> Installing apt packages: ${PACKAGES_TO_INSTALL[*]}"
sudo apt-get update
sudo apt-get install -y "${PACKAGES_TO_INSTALL[@]}"

echo "✓ apt packages installed"
{{- end }}
