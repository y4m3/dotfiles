{{- if and (eq .chezmoi.os "linux") (eq (.profile | default "client") "client") (contains "debian" .chezmoi.osRelease.idLike) -}}
#!/usr/bin/env bash
# Install WezTerm nightly via apt
set -euo pipefail

# Install if not already installed
if command -v wezterm >/dev/null 2>&1; then
    echo "âœ“ wezterm already installed: $(wezterm --version 2>/dev/null || echo "version unknown")"
else
    echo "==> Installing WezTerm (nightly) via apt..."

    # Add WezTerm apt repository
    KEYRING_PATH="/usr/share/keyrings/wezterm-fury.gpg"
    REPO_PATH="/etc/apt/sources.list.d/wezterm.list"

    if [ ! -f "$KEYRING_PATH" ]; then
        echo "==> Adding WezTerm GPG key..."
        curl -fsSL https://apt.fury.io/wez/gpg.key | sudo gpg --yes --dearmor -o "$KEYRING_PATH"
        sudo chmod 644 "$KEYRING_PATH"
    fi

    if [ ! -f "$REPO_PATH" ]; then
        echo "==> Adding WezTerm repository..."
        echo 'deb [signed-by=/usr/share/keyrings/wezterm-fury.gpg] https://apt.fury.io/wez/ * *' | sudo tee "$REPO_PATH"
    fi

    # Install wezterm-nightly
    echo "==> Installing wezterm-nightly package..."
    sudo apt-get update
    sudo apt-get install -y wezterm-nightly

    echo "==> wezterm version: $(wezterm --version)"
fi

# Post-install configuration (always run to ensure correct state)

# Disable WezTerm shell integration
# wezterm-nightly installs /etc/profile.d/wezterm.sh which:
# - Overwrites PROMPT_COMMAND
# - Injects OSC 133 sequences into PS1
# - Breaks starship/bash prompts even when not using WezTerm terminal
# - Affects all login shells including WSL via wsl.exe
WEZTERM_SHELL_INTEGRATION="/etc/profile.d/wezterm.sh"
if [ -f "$WEZTERM_SHELL_INTEGRATION" ]; then
    echo "==> [WARNING] Disabling WezTerm shell integration..."
    echo "    WezTerm apt package installs $WEZTERM_SHELL_INTEGRATION"
    echo "    This breaks PS1/starship prompts. Disabling it now."
    sudo mv "$WEZTERM_SHELL_INTEGRATION" "${WEZTERM_SHELL_INTEGRATION}.disabled"
    echo "==> Shell integration disabled: ${WEZTERM_SHELL_INTEGRATION}.disabled"
fi

# Enable systemd user service (if systemd is available)
if command -v systemctl >/dev/null 2>&1 && systemctl --user >/dev/null 2>&1; then
    systemctl --user daemon-reload
    if ! systemctl --user is-enabled wezterm-mux.service >/dev/null 2>&1; then
        echo "==> Enabling WezTerm mux server service..."
        systemctl --user enable wezterm-mux.service
    fi
fi
{{- end -}}
