#!/bin/bash
# chezmoi:template:left-delimiter="# {{" right-delimiter="}}"
#
# Modify script for .gitconfig
# - Outputs base configuration managed by chezmoi
# - Preserves local-only sections (e.g., credential helpers added by gh auth setup-git)

set -euo pipefail

# Save current content to extract local settings later
CURRENT_CONFIG="$(cat)"

# Output base configuration
cat << 'BASECONFIG'
# Include local user-specific settings (name, email, etc.)
# IMPORTANT: Edit ~/.gitconfig.local before making commits
[include]
    path = ~/.gitconfig.local

[core]
    pager = delta
    editor = vim
    hooksPath = ~/.git-templates/hooks

[init]
    defaultBranch = main

[ghq]
    root = ~/repos

[credential]
# {{- if eq .chezmoi.os "windows" }}
    # Windows: use Git Credential Manager Core
    helper = manager-core
# {{- else }}
    # NOTE: git-credential-cache uses Unix domain sockets and is only available
    # on Linux/Unix systems. On other platforms, configure an appropriate helper
    # in ~/.gitconfig.local to override this default.
    #
    # The following can be overridden in ~/.gitconfig.local.
    helper = cache --timeout=# {{- if env "GIT_CREDENTIAL_CACHE_TIMEOUT" }}# {{ env "GIT_CREDENTIAL_CACHE_TIMEOUT" }}# {{- else }}1800# {{- end }}
# {{- end }}

[fetch]
    prune = true

[pull]
    rebase = false
    ff = only

[push]
    default = simple

[status]
    submoduleSummary = true

[interactive]
    diffFilter = delta --color-only

[delta]
    navigate = true
    side-by-side = true
    line-numbers = true
    features = tokyo-night

[delta "tokyo-night"]
    syntax-theme = OneHalfDark
    file-style = bold #7aa2f7
    hunk-header-style = bold #bb9af7
    minus-style = syntax "#382a33"
    minus-non-emph-style = syntax "#2a1f26"
    minus-empty-style = syntax "#2a1f26"
    plus-style = syntax "#1f2d2d"
    plus-non-emph-style = syntax "#142322"
    plus-empty-style = syntax "#142322"
    zero-style = syntax "#1a1b26"
    line-numbers-zero-style = "#3b4261"
    line-numbers-minus-style = "#f7768e"
    line-numbers-plus-style = "#9ece6a"

[merge]
    conflictstyle = diff3

[diff]
    colorMoved = default
    algorithm = histogram
    mnemonicPrefix = true
    renames = copies

[alias]
    st = status -sb
    co = checkout
    br = branch
    ci = commit
    unstage = reset HEAD --
    last = log -1 HEAD
    lg = log --graph --oneline --decorate --all
    amend = commit --amend --no-edit
BASECONFIG

# Preserve local credential sections (e.g., from gh auth setup-git)
# These are [credential "https://..."] sections, not the plain [credential] section
echo "$CURRENT_CONFIG" | awk '
  /^\[credential "/ { in_section=1; print; next }
  /^\[/ { in_section=0 }
  in_section { print }
'
