#!/usr/bin/env bash
# run_once_010-chezmoi.sh.tmpl
# Install or upgrade chezmoi (dotfiles manager)

set -euo pipefail

echo "==> Checking chezmoi installation..."

# Define correct location
CORRECT_LOCATION="$HOME/.local/bin/chezmoi"

# Check correct location first (highest priority)
if [ -x "$CORRECT_LOCATION" ]; then
  # Capture version output and errors separately
  version_output=$("$CORRECT_LOCATION" --version 2>&1)
  version_exit_code=$?
  if [ $version_exit_code -eq 0 ]; then
    CURRENT_VERSION=$(echo "$version_output" | head -1)
    echo "✓ chezmoi already installed: $CURRENT_VERSION"
  else
    echo "Warning: Failed to get chezmoi version (exit code: $version_exit_code)" >&2
    echo "$version_output" >&2
    CURRENT_VERSION="unknown"
    echo "✓ chezmoi already installed: $CURRENT_VERSION"
  fi
  exit 0
fi

# If not in correct location, check other locations
# Note: We don't move existing binaries to avoid breaking the environment.
# Instead, we'll install to the correct location, which may result in
# multiple chezmoi installations, but the one in $HOME/.local/bin will
# take precedence in PATH if configured correctly.
FOUND_LOCATION=""

# Check PATH
if command -v chezmoi &>/dev/null; then
  FOUND_LOCATION=$(command -v chezmoi)
  if [ "$FOUND_LOCATION" != "$CORRECT_LOCATION" ]; then
    echo "⚠️  chezmoi found in different location: $FOUND_LOCATION"
    echo "   Will install to expected location: $CORRECT_LOCATION"
    echo "   (Existing installation will remain, but $CORRECT_LOCATION takes precedence)"
  fi
fi

echo "==> Installing chezmoi..."

# Ensure ~/.local/bin exists
mkdir -p "$HOME/.local/bin"

# Install chezmoi to $HOME/.local/bin
#
# Security note:
# - The official installer (`get.chezmoi.io`) is convenient but executes remote code.
# - For improved supply-chain safety, you can pin a version and verify checksums:
#     CHEZMOI_VERSION=2.52.0 chezmoi apply
CHEZMOI_VERSION="${CHEZMOI_VERSION:-}"
if [ -n "$CHEZMOI_VERSION" ]; then
  # Normalize (allow "vX.Y.Z" or "X.Y.Z")
  CHEZMOI_VERSION="${CHEZMOI_VERSION#v}"

  tmpdir="$(mktemp -d)"
  trap 'rm -rf "$tmpdir"' EXIT

  arch="$(uname -m)"
  case "$arch" in
    x86_64|amd64) arch="amd64" ;;
    aarch64|arm64) arch="arm64" ;;
    *)
      echo "Error: Unsupported architecture for verified install: $arch" >&2
      exit 1
      ;;
  esac

  tarball="chezmoi_${CHEZMOI_VERSION}_linux_${arch}.tar.gz"
  checksums="chezmoi_${CHEZMOI_VERSION}_checksums.txt"
  base_url="https://github.com/twpayne/chezmoi/releases/download/v${CHEZMOI_VERSION}"

  echo "==> Installing chezmoi v${CHEZMOI_VERSION} with checksum verification..."
  curl -fsSL -o "$tmpdir/$tarball" "$base_url/$tarball"
  curl -fsSL -o "$tmpdir/$checksums" "$base_url/$checksums"

  expected_sha="$(grep " $tarball\$" "$tmpdir/$checksums" | awk '{print $1}')"
  if [ -z "$expected_sha" ]; then
    echo "Error: Could not find checksum for $tarball in $checksums" >&2
    exit 1
  fi
  actual_sha="$(sha256sum "$tmpdir/$tarball" | awk '{print $1}')"
  if [ "$expected_sha" != "$actual_sha" ]; then
    echo "Error: Checksum verification failed for $tarball" >&2
    echo "  expected: $expected_sha" >&2
    echo "  actual:   $actual_sha" >&2
    exit 1
  fi

  tar -xzf "$tmpdir/$tarball" -C "$tmpdir"
  if [ ! -f "$tmpdir/chezmoi" ]; then
    echo "Error: Extracted archive did not contain chezmoi binary" >&2
    exit 1
  fi
  install -m 0755 "$tmpdir/chezmoi" "$CORRECT_LOCATION"
else
  # Using official installer with explicit install path (Ubuntu 24.04)
  curl -fsSL https://get.chezmoi.io | bash -s -- -b "$HOME/.local/bin"
fi

# Post-installation verification - check correct location only
if [ -x "$CORRECT_LOCATION" ]; then
  # Verify installation by checking version
  version_output=$("$CORRECT_LOCATION" --version 2>&1)
  version_exit_code=$?
  if [ $version_exit_code -eq 0 ]; then
    INSTALLED_VERSION=$(echo "$version_output" | head -1)
    echo "✓ chezmoi installed successfully: $INSTALLED_VERSION"
    echo "  Location: $CORRECT_LOCATION"
  else
    echo "❌ chezmoi installation verification failed" >&2
    echo "  Binary exists but --version command failed (exit code: $version_exit_code)" >&2
    echo "  Error output:" >&2
    echo "$version_output" >&2
    exit 1
  fi
else
  echo "❌ chezmoi installation failed"
  echo "  Expected location: $CORRECT_LOCATION"
  echo "  Debug info:"
  echo "    $HOME/.local/bin exists: $([ -d "$HOME/.local/bin" ] && echo "yes" || echo "no")"
  echo "    $CORRECT_LOCATION exists: $([ -f "$CORRECT_LOCATION" ] && echo "yes" || echo "no")"
  exit 1
fi
