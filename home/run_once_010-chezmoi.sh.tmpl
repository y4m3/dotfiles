#!/usr/bin/env bash
# run_once_010-chezmoi.sh.tmpl
# Install or upgrade chezmoi (dotfiles manager)

set -euo pipefail

echo "==> Checking chezmoi installation..."

# Define correct location
CORRECT_LOCATION="$HOME/.local/bin/chezmoi"

# Check correct location first (highest priority)
if [ -x "$CORRECT_LOCATION" ]; then
  CURRENT_VERSION=$("$CORRECT_LOCATION" --version 2>/dev/null | head -1 || echo "unknown")
  echo "✓ chezmoi already installed: $CURRENT_VERSION"
  exit 0
fi

# If not in correct location, check other locations
FOUND_LOCATION=""

# Check PATH
if command -v chezmoi &>/dev/null; then
  FOUND_LOCATION=$(command -v chezmoi)
fi

# If found in wrong location, show error and exit
if [ -n "$FOUND_LOCATION" ]; then
  echo "❌ chezmoi found in wrong location: $FOUND_LOCATION"
  echo "   Expected location: $CORRECT_LOCATION"
  echo ""
  echo "   Please fix this by either:"
  echo "   1. Moving the binary: mv \"$FOUND_LOCATION\" \"$CORRECT_LOCATION\""
  echo "   2. Reinstalling with: curl -fsSL https://get.chezmoi.io | bash -s -- -b \"$HOME/.local/bin\""
  exit 1
fi

echo "==> Installing chezmoi..."

# Ensure ~/.local/bin exists
mkdir -p "$HOME/.local/bin"

# Detect platform and install
case "$(uname -s)" in
Darwin)
  # macOS
  if command -v brew &>/dev/null; then
    brew install chezmoi
  else
    # Fallback: use official installer with explicit path
    curl -fsSL https://get.chezmoi.io | bash -s -- -b "$HOME/.local/bin"
  fi
  ;;
Linux)
  # Linux - use official installer with explicit path
  curl -fsSL https://get.chezmoi.io | bash -s -- -b "$HOME/.local/bin"
  ;;
*)
  echo "❌ Unsupported platform: $(uname -s)"
  exit 1
  ;;
esac

# Post-installation verification - check correct location only
if [ -x "$CORRECT_LOCATION" ]; then
  INSTALLED_VERSION=$("$CORRECT_LOCATION" --version 2>/dev/null | head -1)
  echo "✓ chezmoi installed successfully: $INSTALLED_VERSION"
  echo "  Location: $CORRECT_LOCATION"
else
  echo "❌ chezmoi installation failed"
  echo "  Expected location: $CORRECT_LOCATION"
  echo "  Debug info:"
  echo "    $HOME/.local/bin exists: $([ -d "$HOME/.local/bin" ] && echo "yes" || echo "no")"
  echo "    $CORRECT_LOCATION exists: $([ -f "$CORRECT_LOCATION" ] && echo "yes" || echo "no")"
  exit 1
fi
