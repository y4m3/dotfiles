#!/usr/bin/env bash
# run_once_010-chezmoi.sh.tmpl
# Install or upgrade chezmoi (dotfiles manager)

set -euo pipefail

echo "==> Checking chezmoi installation..."

# Define correct location
CORRECT_LOCATION="$HOME/.local/bin/chezmoi"

# Check correct location first (highest priority)
if [ -x "$CORRECT_LOCATION" ]; then
  if CURRENT_VERSION=$("$CORRECT_LOCATION" --version 2>&1 | head -1); then
    echo "✓ chezmoi already installed: $CURRENT_VERSION"
  else
    echo "Warning: Failed to get chezmoi version" >&2
    echo "✓ chezmoi already installed (version unknown)"
  fi
  exit 0
fi

# If not in correct location, check other locations
# Note: We don't move existing binaries to avoid breaking the environment.
# Instead, we'll install to the correct location, which may result in
# multiple chezmoi installations, but the one in $HOME/.local/bin will
# take precedence in PATH if configured correctly.
FOUND_LOCATION=""

# Check PATH
if command -v chezmoi &>/dev/null; then
  FOUND_LOCATION=$(command -v chezmoi)
  if [ "$FOUND_LOCATION" != "$CORRECT_LOCATION" ]; then
    echo "⚠️  chezmoi found in different location: $FOUND_LOCATION"
    echo "   Will install to expected location: $CORRECT_LOCATION"
    echo "   (Existing installation will remain, but $CORRECT_LOCATION takes precedence)"
  fi
fi

echo "==> Installing chezmoi..."

# Ensure ~/.local/bin exists
mkdir -p "$HOME/.local/bin"

# Install chezmoi to $HOME/.local/bin
# Using official installer with explicit path for Ubuntu 24.04
curl -fsSL https://get.chezmoi.io | bash -s -- -b "$HOME/.local/bin"

# Post-installation verification - check correct location only
if [ -x "$CORRECT_LOCATION" ]; then
  if INSTALLED_VERSION=$("$CORRECT_LOCATION" --version 2>&1 | head -1); then
    echo "✓ chezmoi installed successfully: $INSTALLED_VERSION"
  else
    echo "Warning: Failed to get chezmoi version after installation" >&2
    echo "✓ chezmoi installed successfully (version unknown)"
  fi
  echo "  Location: $CORRECT_LOCATION"
else
  echo "❌ chezmoi installation failed"
  echo "  Expected location: $CORRECT_LOCATION"
  echo "  Debug info:"
  echo "    $HOME/.local/bin exists: $([ -d "$HOME/.local/bin" ] && echo "yes" || echo "no")"
  echo "    $CORRECT_LOCATION exists: $([ -f "$CORRECT_LOCATION" ] && echo "yes" || echo "no")"
  exit 1
fi
