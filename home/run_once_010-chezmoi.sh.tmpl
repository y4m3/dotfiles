#!/usr/bin/env bash
# run_once_010-chezmoi.sh.tmpl
# Install or upgrade chezmoi (dotfiles manager)

set -euo pipefail

echo "==> Checking chezmoi installation..."

# Try multiple ways to find chezmoi
CHEZMOI_BIN=""

# Method 1: Direct PATH lookup
if command -v chezmoi &>/dev/null; then
  CHEZMOI_BIN=$(command -v chezmoi)
# Method 2: Check default installation location
elif [ -x "$HOME/.local/bin/chezmoi" ]; then
  CHEZMOI_BIN="$HOME/.local/bin/chezmoi"
# Method 3: Check system-wide location
elif [ -x /usr/local/bin/chezmoi ]; then
  CHEZMOI_BIN="/usr/local/bin/chezmoi"
fi

# If already installed, exit early
if [ -n "$CHEZMOI_BIN" ]; then
  CURRENT_VERSION=$("$CHEZMOI_BIN" --version 2>/dev/null | head -1 || echo "unknown")
  echo "✓ chezmoi already installed: $CURRENT_VERSION"
  exit 0
fi

echo "==> Installing chezmoi..."

# Ensure ~/.local/bin exists
mkdir -p "$HOME/.local/bin"

# Detect platform and install
case "$(uname -s)" in
Darwin)
  # macOS
  if command -v brew &>/dev/null; then
    brew install chezmoi
  else
    # Fallback: use official installer with explicit path
    curl -fsSL https://get.chezmoi.io | bash -s -- -b "$HOME/.local/bin"
  fi
  ;;
Linux)
  # Linux - use official installer with explicit path
  curl -fsSL https://get.chezmoi.io | bash -s -- -b "$HOME/.local/bin"
  ;;
*)
  echo "❌ Unsupported platform: $(uname -s)"
  exit 1
  ;;
esac

# Post-installation verification - check the installation directory first
CHEZMOI_BIN=""
if [ -x "$HOME/.local/bin/chezmoi" ]; then
  CHEZMOI_BIN="$HOME/.local/bin/chezmoi"
elif [ -x /usr/local/bin/chezmoi ]; then
  CHEZMOI_BIN="/usr/local/bin/chezmoi"
elif command -v chezmoi &>/dev/null; then
  CHEZMOI_BIN=$(command -v chezmoi)
fi

if [ -n "$CHEZMOI_BIN" ] && [ -x "$CHEZMOI_BIN" ]; then
  INSTALLED_VERSION=$("$CHEZMOI_BIN" --version 2>/dev/null | head -1)
  echo "✓ chezmoi installed successfully: $INSTALLED_VERSION"
  echo "  Location: $CHEZMOI_BIN"
else
  echo "❌ chezmoi installation failed"
  echo "  Debug info:"
  echo "    HOME/.local/bin exists: $([ -d "$HOME/.local/bin" ] && echo "yes" || echo "no")"
  echo "    HOME/.local/bin/chezmoi exists: $([ -f "$HOME/.local/bin/chezmoi" ] && echo "yes" || echo "no")"
  echo "    bin/chezmoi exists: $([ -f "bin/chezmoi" ] && echo "yes" || echo "no")"
  exit 1
fi
